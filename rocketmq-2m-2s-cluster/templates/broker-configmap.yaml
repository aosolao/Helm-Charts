---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.brokerConfigMap.name }}
  namespace: {{ .Release.Namespace }}
data:
  # BROKER_MEM sets the broker JVM, if set to "" then Xms = Xmx = max(min(1/2 ram, 1024MB), min(1/4 ram, 8GB))
  BROKER_MEM: {{ .Values.brokerConfigMap.BROKER_MEM | quote }}
  broker-common.conf: |
    # brokerClusterName, brokerName, brokerId are automatically generated by the operator and do not set it manually!!!
    # 删除文件时间点，默认凌晨 4点
    deleteWhen={{ .Values.brokerConfigMap.broker_conf.deleteWhen }}
    # 文件保留时间，默认 48 小时
    fileReservedTime={{ .Values.brokerConfigMap.broker_conf.fileReservedTime }}
    #- ASYNC_FLUSH 异步刷盘
    #- SYNC_FLUSH 同步刷盘
    flushDiskType={{ .Values.brokerConfigMap.broker_conf.flushDiskType }}
    # set brokerRole to ASYNC_MASTER or SYNC_MASTER. DO NOT set to SLAVE because the replica instance will automatically be set!!!
    brokerRole={{ .Values.brokerConfigMap.broker_conf.brokerRole }}
    # ACL开关
    aclEnable={{ .Values.brokerConfigMap.broker_conf.aclEnable }}
    # 从节点可读
    slaveReadEnable={{ .Values.brokerConfigMap.broker_conf.slaveReadEnable }}
    #在发送消息时，自动创建服务器不存在的topic，默认创建的队列数
    defaultTopicQueueNums={{ .Values.brokerConfigMap.broker_conf.defaultTopicQueueNums }}
    #是否允许 Broker 自动创建Topic，建议线下开启，线上关闭
    autoCreateTopicEnable={{ .Values.brokerConfigMap.broker_conf.autoCreateTopicEnable }}
    #是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭
    autoCreateSubscriptionGroup={{ .Values.brokerConfigMap.broker_conf.autoCreateSubscriptionGroup }}
    #commitLog每个文件的大小默认1G
    mapedFileSizeCommitLog={{ .Values.brokerConfigMap.broker_conf.mapedFileSizeCommitLog }}
    #ConsumeQueue每个文件默认存30W条，根据业务情况调整
    mapedFileSizeConsumeQueue={{ .Values.brokerConfigMap.broker_conf.mapedFileSizeConsumeQueue }}
    #检测物理文件磁盘空间
    diskMaxUsedSpaceRatio={{ .Values.brokerConfigMap.broker_conf.diskMaxUsedSpaceRatio }}
    #限制的消息大小
    maxMessageSize={{ .Values.brokerConfigMap.broker_conf.maxMessageSize }}
    {{- if .Values.brokerConfigMap.broker_conf.sendMessageThreadPoolNums }}
    #发消息线程池数量
    #sendMessageThreadPoolNums={{ .Values.brokerConfigMap.broker_conf.sendMessageThreadPoolNums }}
    {{- end }}
    {{- if .Values.brokerConfigMap.broker_conf.pullMessageThreadPoolNums }}
    #拉消息线程池数量
    #pullMessageThreadPoolNums={{ .Values.brokerConfigMap.broker_conf.pullMessageThreadPoolNums }}
    {{- end }}
    # config plain_acl.yml start
    globalWhiteRemoteAddresses:
{{- with .Values.brokerConfigMap.plain_acl_yml.globalWhiteRemoteAddresses }}
{{ toYaml . | indent 6 }}
{{- end }}
    accounts:
{{- with .Values.brokerConfigMap.plain_acl_yml.accounts }}
{{ toYaml . | indent 6 }}
{{- end }}
    # config plain_acl.yml end
    # config tools_yml start
{{- with .Values.brokerConfigMap.tools_yml }}
{{ toYaml . | indent 4 }}
{{- end }}
    # config tools_yml end
